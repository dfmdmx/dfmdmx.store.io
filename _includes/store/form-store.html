<!-- ---------includes--------- -->
{% include utils/messages.html %}
{% include utils/dialogs.html %}
<!-- ---------includes--------- -->

<form id='form-store'>
  <input form='form-store' type="hidden" name="item_type" value="{{ page.title || slugify }}">
  <input form='form-store' type="hidden" id='item_layout' name="item_layout" value="{{ page.layout }}">
  <input form='form-store' type="hidden" name="item_group" value="{{ page.group }}">
  <input form='form-store' type="hidden" id="item_pid" name="item_pid" value="">
</form>

<script>

  var upload_files = [];
  var form_store = $( "#form-store" );

  form_store.on('submit', function( event ) {
    event.preventDefault();
    current_user.always(function(user){
      var method = '{{include.method}}';
      var payload = form_store.serializeFormJSON();
      payload['cart_token'] = cart_token;
      remoteCall(method,payload,upload_files).done(function(response){
        if (method == 'store_form_order')  {
          setCookie('active_order',response.order.id,1);
          window.location.replace("/order");
        }else{
          if (method != 'store_edit_order')  {
            messageHTML('Â¡Listo! <a href="/order-create"> Continuar a crear orden <i class="fas fa-shopping-cart"></i> </a> ');
            form_store.trigger('reset');
            if (upload_files.length != 0){
              reset_files();
            }
          }else{
            location.replace(document.location.href.replace('order-edit','order'));
          }
        }
      }).fail(function(){
        messageAlert('Upps... algo no esta bien.');
      });
    });
  });


  var product = $.Deferred()
  var is_product = false;

  function update_product(){
    current_user.always(function(user){
      var method = 'store_product_query';
      var payload = form_store.serializeFormJSON();
      remoteCall(method,payload,false).done(function(response){
        console.log(response.product);
        product.resolve(response.product).promise();
      }).fail(function(){
        console.log('satetilite malfunction');
        product.reject(false).promise();

      });
    });
  }

  $(document).ready(function () {
    var layout = $('#item_layout').val();
    is_product = layout == 'product' || layout == 'service'
    if (is_product){
      update_product();
      product.done(function(product){
        $('#item_pid').val(product.md5);
      });
      var form_inputs = $("[form='form-store']")
      form_inputs.each(function(e){
        input = form_inputs[e];
        $(input).on('change',function(){
          update_product();
        })
      });

    }else{
      product.reject(false).promise();
    }
  });





</script>
