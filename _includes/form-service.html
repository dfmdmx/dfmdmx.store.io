<!-- ---------includes--------- -->
{% include messages.html %}
<!-- ---------includes--------- -->

<style>
  #guest-group {
      display: none;
  }
  .send-button {
    width : 100% ;
  }
</style>

<div class='form-service'>

  <form id='service'></form>

  <div class="pure-form">
    <legend>Informacion del pedido</legend>
    <div class="pure-g">
      <div class="pure-u-1">
        <!-- <label>Informacion</label> -->
        <fieldset class="pure-group">
          <input form='service' name="nombre-pedido" class="pure-input-1" placeholder="Nombre del pedido" >
          <textarea form='service' name="descripcion-pedido" class="pure-input-1" placeholder="Descripción / Notas"></textarea>
        </fieldset>
      </div>
    </div>
  </div>

  {% include form-upload-files.html %}
  {% include form-user-info.html %}

  <div class="pure-form">
    <legend>Todo listo</legend>
    <div class="pure-g">
      <div class="pure-u-1">
        <p id="message-text"></p>
      </div>
      <div class="pure-u-1-2">
        <button form='service' type="submit" class="pure-button send-button pure-button-primary">Enviar <i class="fas fa-upload"></i></button>
      </div>
    </div>
  </div>

</div>

<script>src="https://www.google.com/recaptcha/api.js?render={{ site.data.callback.captchakey }}"</script>

<script>

  $(document).ready(function () {
    current_user.done(function(){
    }).fail(function(){
      $('#guest-group').css("display","block");
    });
  })

  var form_cnc = $( "#service" );

  form_cnc.on('submit', function( event ) {
    event.preventDefault();
    current_user.done(function(){
      send_call(false);
    }).fail(function(){
      {%- if jekyll.environment == 'production' -%}
      grecaptcha.ready(function() {
          grecaptcha.execute("{{ site.data.callback.captchakey }}", {action: 'form_service'}).then(function(captcha) {
      {%- else -%} var captcha = 'dummy'; {%- endif -%}
      send_call(captcha);
      {%- if jekyll.environment == 'production' -%}
          });
      });
      {%- endif -%}
    });
  });

  function send_call(captcha){
    var method = 'form_service';
    var payload = form_cnc.serializeFormJSON();
    var session_token = getCookie('session_token');
    remoteCall(method,payload,upload_files,captcha,session_token).done(function(response){
      form_cnc.trigger('reset');
      reset_files();
      messageInfo('¡Excelente!');
    }).fail(function(){
      messageAlert('Nop.');
    });
  }

</script>
